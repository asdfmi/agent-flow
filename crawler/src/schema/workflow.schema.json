{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://browgent.dev/schema/workflow.json",
  "type": "object",
  "required": ["steps"],
  "additionalProperties": false,
  "properties": {
    "name": { "type": "string" },
    "description": { "type": "string" },
    "start": { "type": "string", "minLength": 1 },
    "steps": {
      "type": "array",
      "items": { "$ref": "#/$defs/step" },
      "default": []
    }
  },
  "$defs": {
    "step": {
      "oneOf": [
        { "$ref": "#/$defs/navigateStep" },
        { "$ref": "#/$defs/waitStep" },
        { "$ref": "#/$defs/scrollStep" },
        { "$ref": "#/$defs/clickStep" },
        { "$ref": "#/$defs/fillStep" },
        { "$ref": "#/$defs/pressStep" },
        { "$ref": "#/$defs/logStep" },
        { "$ref": "#/$defs/scriptStep" },
        { "$ref": "#/$defs/extractTextStep" },
        { "$ref": "#/$defs/ifStep" },
        { "$ref": "#/$defs/loopStep" }
      ]
    },
    "branch": {
      "type": "object",
      "required": ["next"],
      "additionalProperties": false,
      "properties": {
        "condition": { "$ref": "#/$defs/condition" },
        "next": { "type": "string", "minLength": 1 }
      }
    },
    "xpathTarget": {
      "type": "object",
      "required": ["xpath"],
      "additionalProperties": false,
      "properties": {
        "xpath": { "type": "string", "minLength": 1 }
      }
    },
    "success": {
      "type": "object",
      "required": ["condition"],
      "additionalProperties": false,
      "properties": {
        "timeout": { "type": "number", "exclusiveMinimum": 0 },
        "condition": { "$ref": "#/$defs/condition" }
      }
    },
    "condition": {
      "type": "object",
      "oneOf": [
        {
          "required": ["visible"],
          "additionalProperties": false,
          "properties": {
            "visible": { "$ref": "#/$defs/xpathTarget" }
          }
        },
        {
          "required": ["exists"],
          "additionalProperties": false,
          "properties": {
            "exists": { "$ref": "#/$defs/xpathTarget" }
          }
        },
        {
          "required": ["urlIncludes"],
          "additionalProperties": false,
          "properties": {
            "urlIncludes": { "type": "string" }
          }
        },
        {
          "required": ["delay"],
          "additionalProperties": false,
          "properties": {
            "delay": { "type": "number", "minimum": 0 }
          }
        },
        {
          "required": ["script"],
          "additionalProperties": false,
          "properties": {
            "script": {
              "type": "object",
              "required": ["code"],
              "additionalProperties": false,
              "properties": {
                "code": { "type": "string" }
              }
            }
          }
        }
      ]
    },
    "navigateStep": {
      "type": "object",
      "required": ["id", "type", "url", "label"],
      "additionalProperties": false,
      "properties": {
        "id": { "type": "string", "minLength": 1 },
        "type": { "const": "navigate" },
        "url": { "type": "string", "minLength": 1 },
        "waitUntil": { "type": "string" },
        "success": { "$ref": "#/$defs/success" },
        "label": { "type": "string" },
        "next": { "type": "string", "minLength": 1 }
      }
    },
    "waitStep": {
      "type": "object",
      "required": ["id", "type", "label"],
      "additionalProperties": false,
      "properties": {
        "id": { "type": "string", "minLength": 1 },
        "type": { "const": "wait" },
        "label": { "type": "string" },
        "next": { "type": "string", "minLength": 1 }
      }
    },
    "scrollStep": {
      "type": "object",
      "required": ["id", "type", "label"],
      "additionalProperties": false,
      "properties": {
        "id": { "type": "string", "minLength": 1 },
        "type": { "const": "scroll" },
        "dx": { "type": "number" },
        "dy": { "type": "number" },
        "success": { "$ref": "#/$defs/success" },
        "label": { "type": "string" },
        "next": { "type": "string", "minLength": 1 }
      },
      "anyOf": [
        { "required": ["dx"] },
        { "required": ["dy"] }
      ]
    },
    "clickStep": {
      "type": "object",
      "required": ["id", "type", "xpath", "label"],
      "additionalProperties": false,
      "properties": {
        "id": { "type": "string", "minLength": 1 },
        "type": { "const": "click" },
        "xpath": { "type": "string", "minLength": 1 },
        "options": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "button": { "type": "string" },
            "clickCount": { "type": "integer", "minimum": 1 },
            "delay": { "type": "number", "minimum": 0 },
            "timeout": { "type": "number", "minimum": 0 }
          }
        },
        "success": { "$ref": "#/$defs/success" },
        "label": { "type": "string" },
        "next": { "type": "string", "minLength": 1 }
      }
    },
    "fillStep": {
      "type": "object",
      "required": ["id", "type", "xpath", "value", "label"],
      "additionalProperties": false,
      "properties": {
        "id": { "type": "string", "minLength": 1 },
        "type": { "const": "fill" },
        "xpath": { "type": "string", "minLength": 1 },
        "value": { "type": "string" },
        "clear": { "type": "boolean" },
        "success": { "$ref": "#/$defs/success" },
        "label": { "type": "string" },
        "next": { "type": "string", "minLength": 1 }
      }
    },
    "pressStep": {
      "type": "object",
      "required": ["id", "type", "xpath", "key", "label"],
      "additionalProperties": false,
      "properties": {
        "id": { "type": "string", "minLength": 1 },
        "type": { "const": "press" },
        "xpath": { "type": "string", "minLength": 1 },
        "key": { "type": "string", "minLength": 1 },
        "delay": { "type": "number", "minimum": 0 },
        "success": { "$ref": "#/$defs/success" },
        "label": { "type": "string" },
        "next": { "type": "string", "minLength": 1 }
      }
    },
    "logStep": {
      "type": "object",
      "required": ["id", "type", "label", "message", "target", "level"],
      "additionalProperties": false,
      "properties": {
        "id": { "type": "string", "minLength": 1 },
        "type": { "const": "log" },
        "message": { "type": "string" },
        "target": { "type": "string" },
        "level": { "type": "string" },
        "label": { "type": "string" },
        "next": { "type": "string", "minLength": 1 }
      }
    },
    "scriptStep": {
      "type": "object",
      "required": ["id", "type", "code", "label"],
      "additionalProperties": false,
      "properties": {
        "id": { "type": "string", "minLength": 1 },
        "type": { "const": "script" },
        "code": { "type": "string" },
        "as": { "type": "string" },
        "success": { "$ref": "#/$defs/success" },
        "label": { "type": "string" },
        "next": { "type": "string", "minLength": 1 }
      }
    },
    "extractTextStep": {
      "type": "object",
      "required": ["id", "type", "xpath", "as", "label"],
      "additionalProperties": false,
      "properties": {
        "id": { "type": "string", "minLength": 1 },
        "type": { "const": "extract_text" },
        "xpath": { "type": "string", "minLength": 1 },
        "as": { "type": "string" },
        "success": { "$ref": "#/$defs/success" },
        "label": { "type": "string" },
        "next": { "type": "string", "minLength": 1 }
      }
    },
    "ifStep": {
      "type": "object",
      "required": ["id", "type", "label", "branches"],
      "additionalProperties": false,
      "properties": {
        "id": { "type": "string", "minLength": 1 },
        "type": { "const": "if" },
        "label": { "type": "string" },
        "branches": {
          "type": "array",
          "items": { "$ref": "#/$defs/branch" },
          "minItems": 1
        }
      }
    },
    "loopStep": {
      "type": "object",
      "required": ["id", "type", "label", "next", "exit"],
      "additionalProperties": false,
      "properties": {
        "id": { "type": "string", "minLength": 1 },
        "type": { "const": "loop" },
        "label": { "type": "string" },
        "next": { "type": "string", "minLength": 1 },
        "exit": { "type": "string", "minLength": 1 },
        "times": { "type": "integer", "minimum": 1 },
        "condition": { "$ref": "#/$defs/condition" },
        "as": { "type": "string", "minLength": 1 }
      },
      "allOf": [
        {
          "anyOf": [
            { "required": ["times"] },
            { "required": ["condition"] }
          ]
        }
      ]
    }
  }
}
